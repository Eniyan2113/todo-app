<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic To-Do List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- ...existing code... -->
<style>
    /* Custom styles for the app */
    body {
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        padding: 1rem; /* Add spacing around the main container 123 */
        transition: background-color 0.5s ease;
    }

    .theme-light {
        background: linear-gradient(-45deg, #e0e7ff, #c7d2fe, #a5b4fc, #818cf8);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
    }

    .theme-dark {
        background: linear-gradient(-45deg, #1e293b, #334155, #475569, #0f172a);
        background-size: 400% 400%;
        animation: gradient 15s ease infinite;
    }

    @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    /* Animation for task items */
    .task-item { transition: all 0.3s ease; }
    
    /* Calendar specific styles */
    .calendar-grid {
        grid-template-columns: repeat(7, minmax(0, 1fr));
    }
    .calendar-day {
        min-height: 100px;
    }

    /* --- Improved input visibility for day mode and mobile --- */
    input, select {
        background-color: #fff;
        border: 1px solid #cbd5e1;
        color: #1e293b;
        font-size: 1rem;
        padding: 0.75rem;
    }
    input::placeholder {
        color: #64748b;
        opacity: 1;
    }
    @media (max-width: 640px) {
        #add-task-form .flex {
            flex-direction: column;
        }
        #add-task-form input,
        #add-task-form select,
        #add-task-form button {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
</style>
<!-- ...existing code... -->
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-4xl mx-auto rounded-2xl shadow-2xl p-6 md:p-8 bg-white/70 backdrop-blur-lg border border-white/50">
        <header class="mb-6 flex justify-between items-center">
            <div class="text-center flex-grow">
                <h1 id="app-title" class="text-3xl sm:text-4xl font-bold text-slate-800">My To-Do List</h1>
                <p id="app-subtitle" class="text-slate-500 mt-2">Stay organized, one task at a time.</p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                <svg id="theme-icon-sun" xmlns="http://www.w.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300 hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
            </button>
        </header>

        <!-- ...existing code... -->
        <div id="add-task-form" class="mb-6 space-y-3">
            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                <input type="text" id="taskInput" placeholder="Add a new task..." class="flex-grow p-3 border rounded-lg transition duration-200 bg-white text-slate-800 border-slate-300 placeholder-slate-500">
                <select id="priorityInput" class="p-3 border rounded-lg transition duration-200 font-medium flex-shrink-0 bg-white text-slate-800 border-slate-300">
                    <option value="low">Low Priority</option>
                    <option value="medium" selected>Medium Priority</option>
                    <option value="high">High Priority</option>
                </select>
                <input 
                    type="date" 
                    id="dueDateInput" 
                    class="p-3 border rounded-lg transition duration-200 flex-shrink-0 bg-white text-slate-800 border-slate-300 placeholder-slate-500 text-base w-full sm:w-auto"
                    style="min-height:48px;"
                >
                <button id="addTaskBtn" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center gap-2 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>Add</span>
                </button>
            </div>
            <input type="text" id="tagsInput" placeholder="Add tags, comma separated (e.g. #design, #bugfix)" class="w-full p-3 border rounded-lg transition duration-200 bg-white text-slate-800 border-slate-300 placeholder-slate-500">
        </div>
<!-- ...existing code... -->
        
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
             <div class="relative w-full md:w-auto flex-grow">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="searchInput" placeholder="Search tasks or #tags..." class="w-full pl-10 pr-4 py-2 border rounded-lg">
            </div>
            <div class="p-1 bg-slate-200 dark:bg-slate-700 rounded-lg flex items-center">
                <button data-view="list" class="view-btn p-2 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></button>
                <button data-view="calendar" class="view-btn p-2 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></button>
            </div>
        </div>

        <div id="content-area">
            <div id="list-view" class="view-container">
                 <div class="flex items-center gap-4 mb-4">
                    <div class="flex gap-2">
                        <button data-filter="all" class="filter-btn font-medium px-4 py-2 rounded-lg transition duration-200">All</button>
                        <button data-filter="active" class="filter-btn font-medium px-4 py-2 rounded-lg transition duration-200">Active</button>
                        <button data-filter="completed" class="filter-btn font-medium px-4 py-2 rounded-lg transition duration-200">Completed</button>
                    </div>
                    <button id="clearCompletedBtn" class="ml-auto text-red-500 font-medium px-4 py-2 rounded-lg hover:bg-red-100 dark:hover:bg-red-500/10 transition duration-200 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        <span>Clear</span>
                    </button>
                </div>
                <div id="taskListContainer" class="task-list"></div>
            </div>

            <div id="calendar-view" class="view-container hidden">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&lt;</button>
                    <h2 id="calendar-month-year" class="text-xl font-bold text-slate-700 dark:text-slate-200"></h2>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&gt;</button>
                </div>
                <div class="grid calendar-grid text-center font-semibold text-slate-600 dark:text-slate-400">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="grid calendar-grid border-t border-l border-slate-200 dark:border-slate-700"></div>
            </div>
        </div>

         <div id="emptyMessage" class="text-center py-8 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-400 mb-4"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
            <p id="emptyMessageText" class="text-slate-500 dark:text-slate-400 font-medium">No tasks yet. Add one to get started!</p>
        </div>

        <footer class="text-center mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
            <p class="text-sm text-slate-600 dark:text-slate-300 font-semibold">
                Created by Eniyan A
            </p>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                a.eniyan2113@gmail.com
            </p>
        </footer>
    </div>

    <script>
        // --- 1. CONFIGURATION & INITIALIZATION ---
        
        // --- GLOBAL STATE ---
        const STORAGE_KEY = 'my-todo-app-tasks';
        let tasks = [];
        let currentFilter = 'all';
        let currentView = 'list';
        let currentDate = new Date();

        // --- ELEMENT REFERENCES ---
        const taskInput = document.getElementById('taskInput');
        const tagsInput = document.getElementById('tagsInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const emptyMessage = document.getElementById('emptyMessage');
        const emptyMessageText = document.getElementById('emptyMessageText');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const viewButtons = document.querySelectorAll('.view-btn');
        const priorityInput = document.getElementById('priorityInput');
        const dueDateInput = document.getElementById('dueDateInput');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');
        const searchInput = document.getElementById('searchInput');
        const themeToggle = document.getElementById('theme-toggle');
        const listView = document.getElementById('list-view');
        const calendarView = document.getElementById('calendar-view');
        const taskListContainer = document.getElementById('taskListContainer');

        // --- Color mapping for priorities ---
        const priorityColorClasses = {
            low: { light: 'bg-blue-100 border-blue-300 text-blue-800', dark: 'bg-blue-900/50 border-blue-700 text-blue-300' },
            medium: { light: 'bg-yellow-100 border-yellow-300 text-yellow-800', dark: 'bg-yellow-900/50 border-yellow-700 text-yellow-300' },
            high: { light: 'bg-red-100 border-red-300 text-red-800', dark: 'bg-red-900/50 border-red-700 text-red-300' }
        };

        function updatePriorityInputColor() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            const priority = priorityInput.value;
            Object.values(priorityColorClasses).forEach(themeClasses => {
                priorityInput.classList.remove(...themeClasses.light.split(' '), ...themeClasses.dark.split(' '));
            });
            if (priorityColorClasses[priority]) {
                priorityInput.classList.add(...priorityColorClasses[priority][currentTheme].split(' '));
            }
        }
        
        // --- 2. THEME MANAGEMENT ---
        function applyTheme(theme) {
            const body = document.body;
            const container = document.getElementById('app-container');
            const allInputs = document.querySelectorAll('input, select');
            const appTitle = document.getElementById('app-title');
            const appSubtitle = document.getElementById('app-subtitle');
            const moonIcon = document.getElementById('theme-icon-moon');
            const sunIcon = document.getElementById('theme-icon-sun');
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                body.classList.remove('theme-light'); body.classList.add('theme-dark');
                container.classList.remove('bg-white/70', 'border-white/50'); container.classList.add('bg-slate-800/70', 'border-slate-700');
                appTitle.classList.remove('text-slate-800'); appTitle.classList.add('text-slate-100');
                appSubtitle.classList.remove('text-slate-500'); appSubtitle.classList.add('text-slate-400');
                allInputs.forEach(input => {
                    input.classList.add('bg-slate-800', 'border-slate-600', 'text-slate-200', 'placeholder-slate-500');
                    input.classList.remove('border-slate-300');
                });
                moonIcon.classList.add('hidden'); sunIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                body.classList.remove('theme-dark'); body.classList.add('theme-light');
                container.classList.add('bg-white/70', 'border-white/50'); container.classList.remove('bg-slate-800/70', 'border-slate-700');
                appTitle.classList.add('text-slate-800'); appTitle.classList.remove('text-slate-100');
                appSubtitle.classList.add('text-slate-500'); appSubtitle.classList.remove('text-slate-400');
                allInputs.forEach(input => {
                    input.classList.remove('bg-slate-800', 'border-slate-600', 'text-slate-200', 'placeholder-slate-500');
                     input.classList.add('border-slate-300');
                });
                moonIcon.classList.remove('hidden'); sunIcon.classList.add('hidden');
            }
            updatePriorityInputColor();
            renderContent();
        }

        // --- 3. LOCAL STORAGE LOGIC (Replaces Firestore) ---
        function loadTasksFromLocalStorage() {
            const tasksJSON = localStorage.getItem(STORAGE_KEY);
            // Parse tasks and convert date strings back to Date objects if needed
            tasks = tasksJSON ? JSON.parse(tasksJSON) : [];
        }

        function saveTasksToLocalStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        }
        
        function addTask() {
             const taskText = taskInput.value.trim();
            if (taskText === '') return;
            
            const newTask = {
                id: Date.now().toString(), // Simple unique ID
                text: taskText,
                completed: false,
                createdAt: new Date(),
                priority: priorityInput.value,
                dueDate: dueDateInput.value || null,
                tags: tagsInput.value.split(',').map(tag => tag.trim().replace(/^#/, '')).filter(Boolean)
            };

            tasks.push(newTask);
            saveTasksToLocalStorage();
            
            taskInput.value = ''; 
            dueDateInput.value = ''; 
            tagsInput.value = '';
            
            renderContent();
        }

        function toggleTaskComplete(taskId) { 
            const task = tasks.find(t => t.id === taskId); 
            if (task) {
                task.completed = !task.completed;
                saveTasksToLocalStorage();
                renderContent();
            }
        }
        
        function updateTaskText(taskId, newText) { 
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.text = newText;
                saveTasksToLocalStorage();
                renderContent();
            }
        }

        function deleteTask(taskId) { 
            tasks = tasks.filter(t => t.id !== taskId);
            saveTasksToLocalStorage();
            renderContent();
        }
        
        function clearCompletedTasks() {
            const completedTasks = tasks.filter(task => task.completed);
            if (completedTasks.length === 0) {
                const originalText = clearCompletedBtn.querySelector('span').textContent;
                const svgIcon = clearCompletedBtn.querySelector('svg');
                clearCompletedBtn.disabled = true;
                if (svgIcon) svgIcon.classList.add('hidden');
                clearCompletedBtn.querySelector('span').textContent = 'Nothing to Clear';
                setTimeout(() => {
                    clearCompletedBtn.querySelector('span').textContent = originalText;
                    if (svgIcon) svgIcon.classList.remove('hidden');
                    clearCompletedBtn.disabled = false;
                }, 1500);
                return;
            }
            
            tasks = tasks.filter(task => !task.completed);
            saveTasksToLocalStorage();
            renderContent();
        }

        // --- 4. MASTER RENDER FUNCTION ---
        function renderContent() {
            updateViewButtons();
            
            if (currentView === 'list') {
                listView.classList.remove('hidden');
                calendarView.classList.add('hidden');
                document.querySelector('.flex.items-center.gap-4.mb-4')?.parentElement.classList.remove('hidden');
                renderListView();
            } else if (currentView === 'calendar') {
                listView.classList.add('hidden');
                calendarView.classList.remove('hidden');
                document.querySelector('.flex.items-center.gap-4.mb-4')?.parentElement.classList.add('hidden');
                renderCalendar();
            }
        }
        
        // --- 5. LIST VIEW LOGIC ---
        function renderListView() {
            taskListContainer.innerHTML = '';
            const searchQuery = searchInput.value.toLowerCase();
            const filteredTasks = tasks.filter(task => {
                const textMatch = task.text.toLowerCase().includes(searchQuery);
                const tagMatch = task.tags && task.tags.some(tag => `#${tag.toLowerCase()}`.includes(searchQuery));
                if (searchQuery && !textMatch && !tagMatch) return false;
                if (currentFilter === 'active') return !task.completed;
                if (currentFilter === 'completed') return task.completed;
                return true;
            });

            // Sort for list view
            const priorityOrder = { high: 0, medium: 1, low: 2 };
            filteredTasks.sort((a, b) => (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2));
            
            updateEmptyState(filteredTasks);

            filteredTasks.forEach(task => taskListContainer.appendChild(createTaskElement(task)));
        }
        
        function updateEmptyState(displayTasks) {
            const isContentVisible = displayTasks.length > 0;
            emptyMessage.classList.toggle('hidden', isContentVisible);
            
            if (!isContentVisible) {
                if (tasks.length === 0) {
                    emptyMessageText.textContent = "No tasks yet. Add one to get started!";
                } else {
                    emptyMessageText.textContent = "No tasks match your current filter or search.";
                }
            }
        }

        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            const isCompleted = task.completed;
            const currentTheme = localStorage.getItem('theme') || 'light';
            let taskBgClass = '', taskTextClass = '', checkboxBorderClass = '', dueTextColor = '';
            if (currentTheme === 'dark') { taskBgClass = isCompleted ? 'bg-green-500/10' : 'bg-slate-900/70 border border-slate-700'; taskTextClass = isCompleted ? 'text-slate-400' : 'text-slate-200'; checkboxBorderClass = isCompleted ? 'border-green-500' : 'border-slate-600'; dueTextColor = 'text-slate-400'; } 
            else { taskBgClass = isCompleted ? 'bg-green-100' : 'bg-white border'; taskTextClass = isCompleted ? 'text-slate-500' : 'text-slate-800'; checkboxBorderClass = isCompleted ? 'border-green-500' : 'border-slate-300'; dueTextColor = 'text-slate-500'; }
            const isOverdue = task.dueDate && !task.completed && new Date(task.dueDate) < new Date().setHours(0,0,0,0);
            if (isOverdue) { dueTextColor = 'text-red-600 font-semibold'; }
            taskElement.className = `task-item flex items-center p-3 mb-2 rounded-lg transition duration-200 ${taskBgClass}`;
            taskElement.dataset.id = task.id;
            const priorityClasses = { high: 'bg-red-500', medium: 'bg-yellow-500', low: 'bg-blue-500' };
            const tagsHTML = task.tags ? task.tags.map(tag => `<span class="tag-pill text-xs font-medium mr-1 px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-300 cursor-pointer">#${escapeHTML(tag)}</span>`).join('') : '';
            taskElement.innerHTML = `
                <div class="flex-grow flex items-center cursor-pointer task-content">
                    <div class="w-1.5 h-8 rounded-full ${priorityClasses[task.priority] || 'bg-slate-300'} mr-3"></div>
                    <div class="w-5 h-5 mr-4 rounded-full border-2 ${isCompleted ? 'bg-green-500' : ''} ${checkboxBorderClass} flex items-center justify-center flex-shrink-0">${isCompleted ? '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : ''}</div>
                    <div class="flex-grow ${taskTextClass}">
                        <span class="task-text ${isCompleted ? 'line-through' : ''}">${escapeHTML(task.text)}</span>
                        <input type="text" class="task-edit-input hidden w-full bg-transparent border-b-2" value="${escapeHTML(task.text)}">
                        <div class="mt-2 flex flex-wrap gap-1">${tagsHTML}</div>
                        ${task.dueDate ? `<div class="text-xs mt-1 ${dueTextColor}">Due: ${new Date(task.dueDate).toLocaleDateString()}</div>` : ''}
                    </div>
                </div>
                <div class="flex items-center ml-4">
                    <button class="edit-btn p-2 text-slate-500 hover:text-blue-600 dark:hover:text-blue-400 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                    <button class="delete-btn p-2 text-slate-500 hover:text-red-600 dark:hover:text-red-400 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </div>`;
            return taskElement;
        }

        // --- 6. CALENDAR VIEW LOGIC ---
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearHeader = document.getElementById('calendar-month-year');
            calendarGrid.innerHTML = '';
            
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            
            monthYearHeader.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Add empty cells for padding days
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            const today = new Date();
            const priorityClasses = { high: 'bg-red-500', medium: 'bg-yellow-500', low: 'bg-blue-500' };

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day p-2 border-r border-b border-slate-200 dark:border-slate-700';
                
                const dayNumber = document.createElement('span');
                dayNumber.textContent = day;
                dayNumber.className = 'text-sm font-medium text-slate-700 dark:text-slate-300';

                // Highlight today
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayNumber.classList.add('bg-blue-600', 'text-white', 'rounded-full', 'w-6', 'h-6', 'flex', 'items-center', 'justify-center');
                }
                dayCell.appendChild(dayNumber);

                // Add tasks for this day
                const tasksForDay = tasks.filter(task => {
                    if (!task.dueDate) return false;
                    const taskDate = new Date(task.dueDate);
                    // Adjust for timezone offset to prevent off-by-one day errors
                    const userTimezoneOffset = taskDate.getTimezoneOffset() * 60000;
                    const adjustedTaskDate = new Date(taskDate.getTime() + userTimezoneOffset);
                    return adjustedTaskDate.getFullYear() === year && adjustedTaskDate.getMonth() === month && adjustedTaskDate.getDate() === day;
                });

                if (tasksForDay.length > 0) {
                    const tasksContainer = document.createElement('div');
                    tasksContainer.className = 'mt-2 space-y-1';
                    tasksForDay.forEach(task => {
                        const taskPill = document.createElement('div');
                        taskPill.className = `flex items-center text-xs p-1 rounded ${task.completed ? 'opacity-50' : ''}`;
                        taskPill.innerHTML = `<span class="w-2 h-2 rounded-full ${priorityClasses[task.priority] || 'bg-slate-400'} mr-2"></span><span class="truncate text-slate-600 dark:text-slate-400">${escapeHTML(task.text)}</span>`;
                        tasksContainer.appendChild(taskPill);
                    });
                    dayCell.appendChild(tasksContainer);
                }
                calendarGrid.appendChild(dayCell);
            }
        }
        
        // --- 7. EVENT LISTENERS ---
        function setupEventListeners() {
            addTaskBtn.addEventListener('click', addTask);
            taskInput.addEventListener('keypress', (e) => e.key === 'Enter' && addTask());
            tagsInput.addEventListener('keypress', (e) => e.key === 'Enter' && addTask());
            searchInput.addEventListener('input', () => { if (currentView === 'list') renderListView() });
            clearCompletedBtn.addEventListener('click', clearCompletedTasks);
            
            themeToggle.addEventListener('click', () => {
                const currentTheme = localStorage.getItem('theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            // View Switcher
            viewButtons.forEach(button => {
                button.addEventListener('click', () => {
                    currentView = button.dataset.view;
                    renderContent();
                });
            });
            
            // Calendar Navigation
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            taskListContainer.addEventListener('click', (e) => { const taskElement = e.target.closest('.task-item'); if (!taskElement) return; const taskId = taskElement.dataset.id; if (e.target.classList.contains('tag-pill')) { searchInput.value = e.target.textContent; renderListView(); return; } if (e.target.closest('.task-content') && !taskElement.classList.contains('is-editing')) { toggleTaskComplete(taskId); } if (e.target.closest('.delete-btn')) { taskElement.style.transform = 'translateX(100%)'; taskElement.style.opacity = '0'; setTimeout(() => deleteTask(taskId), 300); } if (e.target.closest('.edit-btn')) { const taskTextSpan = taskElement.querySelector('.task-text'); const editInput = taskElement.querySelector('.task-edit-input'); taskElement.classList.add('is-editing'); taskTextSpan.classList.add('hidden'); editInput.classList.remove('hidden'); editInput.focus(); editInput.select(); } });
            taskListContainer.addEventListener('focusout', (e) => { if (e.target.classList.contains('task-edit-input')) saveTaskEdit(e.target.closest('.task-item')); });
            taskListContainer.addEventListener('keypress', (e) => { if (e.key === 'Enter' && e.target.classList.contains('task-edit-input')) saveTaskEdit(e.target.closest('.task-item')); });
            filterButtons.forEach(button => { button.addEventListener('click', () => { currentFilter = button.dataset.filter; updateFilterButtons(); renderListView(); }); });
        }
        
        function saveTaskEdit(taskElement) { 
            const taskId = taskElement.dataset.id; 
            const editInput = taskElement.querySelector('.task-edit-input'); 
            const newText = editInput.value.trim(); 
            if (newText) {
                updateTaskText(taskId, newText);
            }
            // The re-render will handle hiding the input, but we can do it manually for a smoother feel
            taskElement.classList.remove('is-editing');
            taskElement.querySelector('.task-text').classList.remove('hidden');
            editInput.classList.add('hidden');
        }
        
        // --- UI Update Functions ---
        function updateViewButtons() {
            viewButtons.forEach(btn => {
                if (btn.dataset.view === currentView) {
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                }
            });
        }
        function updateFilterButtons() {
            filterButtons.forEach(btn => {
                if (btn.dataset.filter === currentFilter) {
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.classList.remove('bg-slate-200', 'text-slate-700', 'dark:bg-slate-700', 'dark:text-slate-300');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('bg-slate-200', 'text-slate-700', 'dark:bg-slate-700', 'dark:text-slate-300');
                }
            });
        }
        
        // --- UTILITY ---
        function escapeHTML(str) { 
            const p = document.createElement('p'); 
            p.textContent = str; 
            return p.innerHTML; 
        }

        // --- 8. INITIAL LOAD ---
        function init() {
            loadTasksFromLocalStorage(); // Load tasks from storage first
            applyTheme(localStorage.getItem('theme') || 'light');
            updateFilterButtons();
            setupEventListeners();
            renderContent(); // Initial render
        }
        
        priorityInput.addEventListener('change', updatePriorityInputColor);
        priorityInput.addEventListener('click', updatePriorityInputColor);
        
        // Start the application
        init();

    </script>
</body>
</html>